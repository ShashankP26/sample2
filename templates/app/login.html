{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Xpredict | Login</title>
  <link rel="icon" href="{% static 'xtitle.jpeg' %}" type="image/x-icon">
  <link href="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta20/dist/css/tabler.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
  <style>
    :root {
      --yellow: #FFD700;
      --blue: #206bc4;
      --orange: #F97316;
      --black: #1E293B;
      --bg-light: #F1F5F9;
    }

    body {
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      height: 100vh;
      margin: 0;
      overflow: hidden;
      font-family: 'Inter', sans-serif;
      color: var(--black);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #particle-canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
    }

    .login-card {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.5);
      padding: 3rem 4rem;
      border-radius: 24px;
      width: 100%;
      max-width: 480px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.1);
      z-index: 10;
      position: relative;
      transform: translateY(0);
      transition: transform 0.3s ease;
    }

    .login-card:hover {
      transform: translateY(-5px);
    }

    /* Bots Container */
    #anim-stage {
      display: flex;
      justify-content: center;
      gap: 20px;
      align-items: flex-end;
      height: 120px;
      margin-bottom: 2rem;
      transform-origin: center bottom;
      transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    /* Scale down bots slightly to fit better */
    .bot {
      transform: scale(0.8);
      transform-origin: bottom center;
      transition: all 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      overflow: visible !important;
    }

    /* Reactive states for bots */
    .watching #anim-stage {
      transform: translateY(-10px);
    }

    .covering #anim-stage {
      transform: translateY(10px) scale(0.95);
    }

    /* Bot Base & Eye Protection */
    .eye-lid {
      transition: opacity 0.3s;
      opacity: 0;
      pointer-events: none;
    }

    .covering .eye-lid {
      opacity: 1;
    }

    .covering .pupil {
      opacity: 0;
    }

    .covering .eye-white {
      fill: rgba(255, 255, 255, 0.1) !important;
      transition: fill 0.3s;
    }

    /* Purple Bot Arm Polish */
    .arm {
      transition: transform 0.7s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      transform-origin: center bottom;
    }

    .covering .arm-l {
      transform: translate(24px, -48px) rotate(145deg);
    }

    .covering .arm-r {
      transform: translate(-24px, -48px) rotate(-145deg);
    }

    /* Head Movements */
    .head-group {
      transition: transform 0.5s ease;
      transform-origin: center bottom;
    }

    .watching .head-group {
      transform: rotate(-5deg);
    }

    .covering .head-group {
      transform: rotate(15deg) translateY(5px);
    }

    /* Blink Animation */
    @keyframes blink {

      0%,
      92%,
      100% {
        transform: scaleY(1);
      }

      96% {
        transform: scaleY(0.1);
      }
    }

    .eye-group {
      transform-origin: center;
      animation: blink 5s infinite;
    }

    .covering .eye-group {
      animation: none;
    }

    .form-control {
      background: rgba(255, 255, 255, 0.8);
      border: 2px solid #E2E8F0;
      padding: 0.9rem 1.2rem;
      font-size: 1rem;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border-radius: 14px;
    }

    .form-control:focus {
      background: white;
      border-color: var(--blue);
      box-shadow: 0 0 0 4px rgba(32, 107, 196, 0.15);
      transform: scale(1.01);
    }

    .login-btn {
      background: var(--black);
      color: white;
      border: none;
      padding: 1.2rem;
      width: 100%;
      border-radius: 14px;
      font-weight: 700;
      font-size: 1.1rem;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 1.5rem;
      letter-spacing: 0.5px;
    }

    .login-btn:hover {
      background: #000;
      transform: translateY(-3px);
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
    }

    .logo-img {
      mix-blend-mode: multiply;
    }
  </style>
</head>

<body>
  <canvas id="particle-canvas"></canvas>

  <div class="login-card">
    <div id="anim-stage">
      <!-- YELLOW BOT -->
      <svg width="100" height="120" viewBox="0 0 100 120" class="bot">
        <g class="head-group">
          <path d="M10 90 Q50 0 90 90 Z" fill="var(--yellow)" />
          <g class="eye-group">
            <circle cx="35" cy="65" r="9" fill="white" class="eye-white" />
            <circle id="p1l" cx="35" cy="65" r="4" fill="var(--black)" class="pupil" />
            <path d="M26 65 Q35 60 44 65" fill="none" stroke="var(--black)" stroke-width="3" class="eye-lid" />
          </g>
          <g class="eye-group">
            <circle cx="65" cy="65" r="9" fill="white" class="eye-white" />
            <circle id="p1r" cx="65" cy="65" r="4" fill="var(--black)" class="pupil" />
            <path d="M56 65 Q65 60 74 65" fill="none" stroke="var(--black)" stroke-width="3" class="eye-lid" />
          </g>
          <!-- Smile -->
          <path d="M40 80 Q50 88 60 80" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" />
        </g>
      </svg>

      <!-- PURPLE BOT (The shy eye-coverer) -->
      <svg width="120" height="130" viewBox="0 0 100 120" class="bot">
        <!-- Eyes Group -->
        <g class="head-group">
          <rect x="15" y="30" width="70" height="70" rx="20" fill="var(--blue)" />
          <g class="eye-group">
            <circle cx="35" cy="60" r="8" fill="white" class="eye-white" />
            <circle id="p2l" cx="35" cy="60" r="4" fill="var(--black)" class="pupil" />
          </g>
          <g class="eye-group">
            <circle cx="65" cy="60" r="8" fill="white" class="eye-white" />
            <circle id="p2r" cx="65" cy="60" r="4" fill="var(--black)" class="pupil" />
          </g>
          <!-- Smile -->
          <path d="M35 78 Q50 88 65 78" fill="none" stroke="white" stroke-width="4" stroke-linecap="round" />
          <!-- Eyelids -->
          <rect x="27" y="58" width="16" height="4" rx="2" fill="var(--black)" class="eye-lid" />
          <rect x="57" y="58" width="16" height="4" rx="2" fill="var(--black)" class="eye-lid" />
        </g>
        <!-- Arms -->
        <rect x="10" y="75" width="14" height="35" rx="7" fill="#1a56a6" class="arm arm-l" />
        <rect x="76" y="75" width="14" height="35" rx="7" fill="#1a56a6" class="arm arm-r" />
      </svg>

      <!-- ORANGE BOT -->
      <svg width="90" height="120" viewBox="0 0 100 120" class="bot">
        <g class="head-group">
          <circle cx="50" cy="80" r="35" fill="var(--orange)" />
          <g class="eye-group">
            <circle cx="35" cy="70" r="8" fill="white" class="eye-white" />
            <circle id="p3l" cx="35" cy="70" r="4" fill="var(--black)" class="pupil" />
            <path d="M27 70 Q35 63 43 70" fill="none" stroke="var(--black)" stroke-width="3" class="eye-lid" />
          </g>
          <g class="eye-group">
            <circle cx="65" cy="70" r="8" fill="white" class="eye-white" />
            <circle id="p3r" cx="65" cy="70" r="4" fill="var(--black)" class="pupil" />
            <path d="M57 70 Q65 63 73 70" fill="none" stroke="var(--black)" stroke-width="3" class="eye-lid" />
          </g>
          <!-- Smile -->
          <path d="M35 85 Q50 95 65 85" fill="none" stroke="white" stroke-width="4" stroke-linecap="round" />
        </g>
      </svg>
    </div>

    <div class="text-center mb-4">
      <h1 class="fw-bold h2">Welcome Back</h1>
      <p class="text-muted small">Enter your credentials to access the workspace</p>
    </div>

    {% if messages %}
    {% for message in messages %}
    <div
      class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} shadow-sm border-0 rounded-3 mb-4">
      {{ message }}</div>
    {% endfor %}
    {% endif %}

    <div id="login-form">
      <form method="post">
        {% csrf_token %}
        <div class="mb-4">
          <label class="form-label small fw-bold text-uppercase opacity-50">Username</label>
          <input type="text" name="username" id="id_username" class="form-control" placeholder="Enter username" required
            autofocus>
        </div>

        <div class="mb-4">
          <label class="form-label small fw-bold text-uppercase opacity-50">Password</label>
          <div class="input-group input-group-flat">
            <input type="password" name="password" id="id_password" class="form-control" placeholder="••••••••"
              required>
            <span class="input-group-text">
              <a href="#" class="link-secondary" title="Show password" data-bs-toggle="tooltip"
                onclick="togglePassword(); return false;" id="togglePassword">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
                  stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                  <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
                  <path d="M21 12c-2.4 4 -5.4 6 -9 6c-3.6 0 -6.6 -2 -9 -6c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6" />
                </svg>
              </a>
            </span>
          </div>
        </div>

        <button type="submit" class="login-btn">
          Login
        </button>
        <div class="text-center mt-3">
          <a href="{% url 'password_reset' %}" class="small text-muted">I forgot password</a>
        </div>
      </form>
    </div>

    <div class="mt-4 text-center">
      <img src="{% static 'xlogo.png' %}" height="30" class="logo-img opacity-50 grayscale">
    </div>
  </div>

  <script>
    const usernameInput = document.getElementById('id_username');
    const passwordInput = document.getElementById('id_password');
    // Using login-card as the wrapper for state classes essentially
    const wrapper = document.querySelector('.login-card');

    function togglePassword() {
      let passwordField = document.getElementById("id_password");
      let eyeIcon = document.getElementById("togglePassword").querySelector('svg');

      if (passwordField.type === "password") {
        passwordField.type = "text";  // Show password
        eyeIcon.innerHTML = `<path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" /><path d="M3 3l18 18"/><path d="M17 17a8 8 0 0 1 -10 0m-2 -2a8 8 0 0 1 -2 -4c2.4 -4 5.4 -6 9 -6a8 8 0 0 1 8 6c-.223 .89 -.614 1.736 -1.142 2.5" />`; // Eye-off icon
      } else {
        passwordField.type = "password"; // Hide password
        eyeIcon.innerHTML = `<path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" /><path d="M21 12c-2.4 4 -5.4 6 -9 6c-3.6 0 -6.6 -2 -9 -6c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6" />`; // Eye icon
      }
      // Force focus to ensure bots keep covering eyes
      passwordField.focus();
    }

    const pupils = [
      { el: document.getElementById('p1l'), cx: 0, cy: 0 },
      { el: document.getElementById('p1r'), cx: 0, cy: 0 },
      { el: document.getElementById('p2l'), cx: 0, cy: 0 },
      { el: document.getElementById('p2r'), cx: 0, cy: 0 },
      { el: document.getElementById('p3l'), cx: 0, cy: 0 },
      { el: document.getElementById('p3r'), cx: 0, cy: 0 }
    ];

    // Initialize centers
    function updateCenters() {
      pupils.forEach(p => {
        const rect = p.el.getBoundingClientRect();
        p.cx = rect.left + rect.width / 2;
        p.cy = rect.top + rect.height / 2;
      });
    }
    window.addEventListener('resize', updateCenters);
    setTimeout(updateCenters, 500);

    // GLOBAL MOUSE TRACKING
    document.addEventListener('mousemove', (e) => {
      if (document.body.classList.contains('covering')) return;

      const mouseX = e.clientX;
      const mouseY = e.clientY;

      pupils.forEach(p => {
        const dx = mouseX - p.cx;
        const dy = mouseY - p.cy;
        const dist = Math.sqrt(dx * dx + dy * dy);

        // Limit pupil movement to 6px radius
        const limit = 6;
        const angle = Math.atan2(dy, dx);

        const moveX = Math.cos(angle) * Math.min(dist / 50, limit);
        const moveY = Math.sin(angle) * Math.min(dist / 50, limit);

        p.el.setAttribute('transform', `translate(${moveX}, ${moveY})`);
      });
    });

    function resetPupils() {
      pupils.forEach(p => p.el.setAttribute('transform', 'translate(0, 0)'));
    }

    // --- PARTICLE SYSTEM ---
    const canvas = document.getElementById('particle-canvas');
    const ctx = canvas.getContext('2d');
    let particles = [];

    function resizeCanvas() {
      // Resize to window since it is fixed
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }

    class Particle {
      constructor() {
        this.x = Math.random() * canvas.width;
        this.y = Math.random() * canvas.height;
        this.size = Math.random() * 2 + 0.5;
        this.speedX = Math.random() * 0.4 - 0.2;
        this.speedY = Math.random() * 0.4 - 0.2;
        this.opacity = Math.random() * 0.5 + 0.2;

        // Anti-Gravity Palette (Darker for Light Mode)
        const colors = [
          'rgba(8, 145, 178, ',   // Darker Cyan
          'rgba(30, 64, 175, ',   // Deep Blue
          'rgba(124, 58, 237, '   // Dark Purple
        ];
        this.colorBase = colors[Math.floor(Math.random() * colors.length)];
      }
      update() {
        this.x += this.speedX;
        this.y += this.speedY;
        if (this.x > canvas.width) this.x = 0;
        else if (this.x < 0) this.x = canvas.width;
        if (this.y > canvas.height) this.y = 0;
        else if (this.y < 0) this.y = canvas.height;
      }
      draw() {
        ctx.fillStyle = this.colorBase + this.opacity + ')';
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
        ctx.fill();
      }
    }


    function initParticles() {
      particles = [];
      for (let i = 0; i < 120; i++) { // Increased particle count for full screen
        particles.push(new Particle());
      }
    }

    function animateParticles() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      for (let i = 0; i < particles.length; i++) {
        particles[i].update();
        particles[i].draw();

        // Draw lines between nearby particles
        for (let j = i + 1; j < particles.length; j++) {
          const dx = particles[i].x - particles[j].x;
          const dy = particles[i].y - particles[j].y;
          const distance = Math.sqrt(dx * dx + dy * dy);

          if (distance < 120) {
            ctx.beginPath();
            ctx.strokeStyle = `rgba(8, 145, 178, ${0.2 * (1 - distance / 120)})`; // Darker Cyan Lines
            ctx.lineWidth = 0.6;
            ctx.moveTo(particles[i].x, particles[i].y);
            ctx.lineTo(particles[j].x, particles[j].y);
            ctx.stroke();
          }
        }
      }

      requestAnimationFrame(animateParticles);
    }


    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();
    initParticles();
    animateParticles();

    // FORM BEHAVIORS
    usernameInput.addEventListener('focus', () => {
      document.body.classList.add('watching'); // Apply to body or wrapper? Styling uses .watching #anim-stage
      wrapper.classList.add('watching');
    });

    usernameInput.addEventListener('blur', () => {
      wrapper.classList.remove('watching');
    });

    passwordInput.addEventListener('focus', () => {
      wrapper.classList.add('covering');
      wrapper.classList.remove('watching');
      document.body.classList.add('covering'); // For mousemove check
    });

    passwordInput.addEventListener('blur', () => {
      wrapper.classList.remove('covering');
      document.body.classList.remove('covering');
      updateCenters();
    });
  </script>
</body>

</html>