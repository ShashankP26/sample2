{% extends 'base.html' %}

{% block content %}
<div class="container-fluid mt-5">
    <div class="row mb-4">
        <!-- Left-aligned Buttons Section (E-Vouchers, Export, Filter by Item Type) -->
        <div class="col-12 col-md-8 d-flex justify-content-start align-items-center flex-wrap gap-3 mb-3 mb-md-0">
            <!-- E-Vouchers Dropdown -->
            <div class="dropdown">
                <button class="btn btn-primary btn-sm dropdown-toggle" type="button" id="voucherDropdown" data-bs-toggle="dropdown" aria-expanded="false" style="padding: 7px 12px;">
                    E-Vouchers
                </button>
                <ul class="dropdown-menu" aria-labelledby="voucherDropdown">
                    <li><a class="dropdown-item" href="{% url 'new_item_form' user.id %}">New E-Voucher</a></li>
                    <li><a class="dropdown-item" href="{% url 'draft_vouchers' %}">Draft Vouchers</a></li>
                </ul>
            </div>

            <!-- Export Dropdown -->
            <div class="dropdown">
                <button class="btn btn-secondary btn-sm dropdown-toggle" type="button" id="exportDropdown" data-bs-toggle="dropdown" aria-expanded="false" style="padding: 7px 12px;">
                    Export
                </button>
                <ul class="dropdown-menu" aria-labelledby="exportDropdown">
                    <li><a href="{% url 'export_vouchers' %}?format=xlsx" class="dropdown-item">Export as XLSX</a></li>
                    <li><a href="{% url 'export_vouchers' %}?format=csv" class="dropdown-item">Export as CSV</a></li>
                    <li><a href="{% url 'export_vouchers' %}?format=pdf" class="dropdown-item">Export as PDF</a></li>
                </ul>
            </div>

            <!-- Filter by Item Type -->
            {% if user.is_staff or user.is_superuser %}
            <div class="dropdown">
                <button class="btn btn-primary btn-sm dropdown-toggle" type="button" id="filterDropdown" data-bs-toggle="dropdown" aria-expanded="false" style="padding: 7px 12px;">
                    {% if request.GET.item_type %}
                        {{ request.GET.item_type }}
                    {% else %}
                        Filter by Item Type
                    {% endif %}
                </button>
                <ul class="dropdown-menu" aria-labelledby="filterDropdown">
                    <li><a class="dropdown-item" href="{% url 'item_form' %}?item_type=">All Item Types</a></li>
                    {% for item_type in item_types %}
                    <li><a class="dropdown-item" href="{% url 'item_form' %}?item_type={{ item_type }}">{{ item_type }}</a></li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>

        <!-- Add a gap for smaller screens -->
        <div class="w-100 d-block d-md-none"></div> <!-- Creates a gap for small screens -->

        <!-- Right-aligned Buttons Section (Filter by Date, Search, and Clear) -->
        <div class="col-12 col-md-4 d-flex justify-content-end align-items-center gap-3">
            <!-- Filter by Date -->
            <div class="dropdown">
                <button class="btn btn-primary btn-sm" type="button" id="filterDateButton" data-bs-toggle="dropdown" aria-expanded="false" style="padding: 7px 12px;">
                    Filter by Date
                </button>
                <div id="dateFields" class="dropdown-menu dropdown-menu-end p-3" style="width: auto; display: none;  ">
                    <div class="d-flex flex-column gap-2">
                        <label for="fromDateField" class="form-label mb-0">From:</label>
                        <input type="date" name="transaction_date_from" class="form-control form-control-sm" id="fromDateField">
                        <label for="toDateField" class="form-label mb-0">To:</label>
                        <input type="date" name="transaction_date_to" class="form-control form-control-sm" id="toDateField">
                        <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="applyFilterButton">Apply Filter</button>
                    </div>
                </div>
            </div>

            <!-- Search Bar Section -->
            <form method="get" action="{% url 'item_form' %}" autocomplete="off" class="d-flex align-items-center gap-2">
                <div class="input-group">
                    <span class="input-group-text bg-light">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                            <path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0"/>
                            <path d="M21 21l-6 -6"/>
                        </svg>
                    </span>
                    <input type="text" name="q" value="{{ request.GET.q }}" class="form-control form-control-sm" placeholder="Searchâ€¦" aria-label="Search">
                </div>
            </form>

            <!-- Clear Button -->
            <button type="button" class="btn btn-outline-danger btn-sm" id="clearButton" style="padding: 7px 12px;">Clear</button>
        </div>
    </div>
</div>
    <!-- Expenses Table -->
    <div class="table-responsive shadow-sm rounded">
        <table class="table table-striped table-hover align-middle" style="border-collapse: collapse;">
            <thead class="table-dark">
                <tr>
                    <th style="width: 12%; border: 1px solid #ddd; padding: 8px;">Applied Date</th>
                    <th style="width: 30%; border: 1px solid #ddd; padding: 8px;">User</th>
                    <th style="width: 22%; border: 1px solid #ddd; padding: 8px;">EV num</th>
                    <th style="width: 30%; border: 1px solid #ddd; padding: 8px;">Item Type</th>
                    <th style="width: 15%; border: 1px solid #ddd; padding: 8px;">Item Name / Remarks</th>
                    <th style="width: 15%; border: 1px solid #ddd; padding: 8px;">Payment Category</th>
                    <th style="width: 10%; border: 1px solid #ddd; padding: 8px;">T Category</th>
                    <th style="width: 10%; border: 1px solid #ddd; padding: 8px;">T Details</th>
                    <th style="width: 10%; border: 1px solid #ddd; padding: 8px;">Amount</th>
                    <th style="width: 10%; border: 1px solid #ddd; padding: 8px;">Transaction Date</th>
                    <th style="width: 15%; border: 1px solid #ddd; padding: 8px;">Uploaded File</th>
                    <th style="width: 10%; border: 1px solid #ddd; padding: 8px;">Payment Mode</th>
                    <th style="width: 10%; border: 1px solid #ddd; padding: 8px;">Actions</th>
                    <th style="width: 10%; border: 1px solid #ddd; padding: 8px;">Payment Status</th>
                    

                </tr>
            </thead>
            <tbody>
                {% for exp in expenses %}
                <tr>
                    <td class="text-center" style="border: 1px solid #ddd; padding: 8px;">{{ exp.date }}</td>
                    <td class="text-center" style="border: 1px solid #ddd; padding: 8px;">{{ exp.created_by }}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">{{ exp.evoucher_number }}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">{{ exp.item_type }}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">{{ exp.item_name }}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">
                        <div>
                            {% if exp.transaction_option == 'gst' and exp.gst_photo %}
                                <p><strong>GST</strong></p>
                                <a href="{{ exp.gst_photo.url }}" class="btn btn-info btn-sm" target="_blank">Download GST</a>
                            
                            {% elif exp.transaction_option == 'bill' and exp.bill_photo %}
                                <p><strong>Bill</strong></p>
                                <a href="{{ exp.bill_photo.url }}" class="btn btn-info btn-sm" target="_blank">Download Bill</a>
                            
                            {% elif exp.transaction_option == 'voucher' %}
                                <p><strong>Voucher</strong></p>
                                {% if exp.voucher_number %}
                                    <p>{{ exp.voucher_number }}</p>
                                {% else %}
                                    <p class="text-danger">Voucher selected but number not provided</p>
                                {% endif %}
                            
                            {% elif exp.transaction_option %}
                                <p>{{ exp.transaction_option|title }} selected</p>
                            
                            {% else %}
                                <span class="text-muted">No File, Voucher, or Conveyance</span>
                            {% endif %}
                        </div>
                    </td>
                    <td style="border: 1px solid #ddd; padding: 8px;">{{ exp.transaction_category }}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">
                        {% if exp.transaction_category == 'internal' %}
                            {{ exp.internal_option }}
                        {% elif exp.transaction_category == 'external' %}
                            {{ exp.external_type }}
                        {% endif %}
                    </td>
                    <td class="text-center" style="border: 1px solid #ddd; padding: 8px;">{{ exp.amount }}</td>
                    
                    <td style="border: 1px solid #ddd; padding: 8px;">{{ exp.transaction_date }}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">
                        {% if exp.proof_photo %}
                            <a href="{{ exp.proof_photo.url }}" class="btn btn-info btn-sm" target="_blank">Download Proof</a>
                        {% else %}
                            <button id="no-proof-button" class="btn btn-danger btn-sm" disabled>No Proof</button>
                        {% endif %}
                    </td>
                    <td class="text-center" style="border: 1px solid #ddd; padding: 8px;">{{ exp.payment_mode }}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">
                        {% if exp.status == 'paid' %}
                            <button class="btn btn-primary btn-sm" style="padding: 5px 20px;" disabled>Edit</button>
                        {% else %}
                            <a href="{% url 'edit_item' exp.id %}" class="btn btn-primary btn-sm" style="padding: 5px 20px;">Edit</a>
                        {% endif %}
                    </td>
                    <td class="text-center" style="border: 1px solid #ddd; padding: 8px;">
                        {% if exp.status == 'paid' %}
                            <span class="stamp bg-success text-white">
                                <!-- Success Tabler SVG Icon -->
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="icon icon-tabler icon-tabler-rosette-discount-check">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                    <path d="M12.01 2.011a3.2 3.2 0 0 1 2.113 .797l.154 .145l.698 .698a1.2 1.2 0 0 0 .71 .341l.135 .008h1a3.2 3.2 0 0 1 3.195 3.018l.005 .182v1c0 .27 .092 .533 .258 .743l.09 .1l.697 .698a3.2 3.2 0 0 1 .147 4.382l-.145 .154l-.698 .698a1.2 1.2 0 0 0 -.341 .71l-.008 .135v1a3.2 3.2 0 0 1 -3.018 3.195l-.182 .005h-1a1.2 1.2 0 0 0 -.743 .258l-.1 .09l-.698 .697a3.2 3.2 0 0 1 -4.382 .147l-.154 -.145l-.698 -.698a1.2 1.2 0 0 0 -.71 -.341l-.135 -.008h-1a3.2 3.2 0 0 1 -3.195 -3.018l-.005 -.182v-1a1.2 1.2 0 0 0 -.258 -.743l-.09 -.1l-.697 -.698a3.2 3.2 0 0 1 -.147 -4.382l.145 -.154l.698 -.698a1.2 1.2 0 0 0 .341 -.71l.008 -.135v-1l.005 -.182a3.2 3.2 0 0 1 3.013 -3.013l.182 -.005h1a1.2 1.2 0 0 0 .743 -.258l.1 -.09l.698 -.697a3.2 3.2 0 0 1 2.269 -.944zm3.697 7.282a1 1 0 0 0 -1.414 0l-3.293 3.292l-1.293 -1.292l-.094 -.083a1 1 0 0 0 -1.32 1.497l2 2l.094 .083a1 1 0 0 0 1.32 -.083l4 -4l.083 -.094a1 1 0 0 0 -.083 -1.32z"/>
                                </svg>
                                Paid
                            </span>
                        {% else %}
                            <span class="stamp bg-danger text-white">
                                <!-- Pending Tabler SVG Icon -->
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="icon icon-tabler icon-tabler-pennant">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                    <path d="M10 2a1 1 0 0 1 .993 .883l.007 .117v.35l8.406 3.736c.752 .335 .79 1.365 .113 1.77l-.113 .058l-8.406 3.735v7.351h1a1 1 0 0 1 .117 1.993l-.117 .007h-4a1 1 0 0 1 -.117 -1.993l.117 -.007h1v-17a1 1 0 0 1 1 -1z"/>
                                </svg>
                                Pending
                            </span>
                        {% endif %}
                    </td>
                    
                    
                </tr>
                {% empty %}
                <tr>
                    <td colspan="12" class="text-center text-muted">No records found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>


<script>
    document.addEventListener('DOMContentLoaded', function () {
    const filterDateButton = document.getElementById('filterDateButton');
    const dateFields = document.getElementById('dateFields');
    const clearButton = document.getElementById('clearButton');
    const applyFilterButton = document.getElementById('applyFilterButton');

    // Toggle the visibility of date fields
    if (filterDateButton && dateFields) {
        filterDateButton.addEventListener('click', function () {
            const isHidden = dateFields.classList.contains('d-none');
            dateFields.classList.toggle('d-none', !isHidden);
            dateFields.style.display = isHidden ? 'flex' : 'none';
        });
    }

    // Clear date fields and search input
    if (clearButton) {
        clearButton.addEventListener('click', function () {
            const fromDateField = document.getElementById('fromDateField');
            const toDateField = document.getElementById('toDateField');
            const searchField = document.querySelector('input[name="q"]');

            if (fromDateField) fromDateField.value = '';
            if (toDateField) toDateField.value = '';
            if (searchField) searchField.value = '';

            // Reload the page to reset the filters
            window.location.href = window.location.pathname;
        });
    }

    // Apply the date filter
    if (applyFilterButton) {
        applyFilterButton.addEventListener('click', function () {
            const fromDate = document.getElementById('fromDateField').value;
            const toDate = document.getElementById('toDateField').value;

            if (fromDate || toDate) {
                const urlParams = new URLSearchParams();
                if (fromDate) urlParams.append('transaction_date_from', fromDate);
                if (toDate) urlParams.append('transaction_date_to', toDate);
                window.location.href = `?${urlParams.toString()}`;
            } else {
                alert('Please enter valid dates!');
            }
        });
    }
});                                              
    window.onload = function () {
        // XLSX Export
        document.getElementById('downloadXlsx').addEventListener('click', function() {
            const table = document.querySelector('table');
            if (table) {
                const wb = XLSX.utils.table_to_book(table);
                XLSX.writeFile(wb, 'vouchers.xlsx');
            }
        });

        // PDF Export
        document.getElementById('downloadPdf').addEventListener('click', function() {
            const doc = new jsPDF();
            doc.autoTable({ html: 'table' });
            doc.save('vouchers.pdf');
        });

        // CSV Export
        document.getElementById('downloadCsv').addEventListener('click', function() {
            const table = document.querySelector('table');
            if (table) {
                let csvContent = "data:text/csv;charset=utf-8,";
                const headers = [];
                table.querySelectorAll('th').forEach(cell => headers.push(cell.innerText));
                csvContent += headers.join(",") + "\r\n";

                table.querySelectorAll('tr').forEach(row => {
                    const rowData = [];
                    row.querySelectorAll('td').forEach(cell => rowData.push(cell.innerText));
                    if (rowData.length > 0) {
                        csvContent += rowData.join(",") + "\r\n";
                    }
                });

                const link = document.createElement('a');
                link.setAttribute('href', encodeURI(csvContent));
                link.setAttribute('download', 'vouchers.csv');
                link.click();
            }
        });
    };
    document.getElementById('clearButton').addEventListener('click', function () {
    const url = new URL(window.location.href);

    // Remove search query
    url.searchParams.delete('q');

    // Remove date filter parameters
    url.searchParams.delete('transaction_date_from');
    url.searchParams.delete('transaction_date_to');

    // Reset date fields in the form (if visible)
    const fromDateField = document.getElementById('fromDateField');
    const toDateField = document.getElementById('toDateField');
    if (fromDateField && toDateField) {
        fromDateField.value = '';
        toDateField.value = '';
    }

    // Redirect to the cleaned URL
    window.location.href = url.toString();
});
{% comment %} function printPage() {
        window.print();  // This will open the browser's print dialog
    } {% endcomment %}
</script>
<style>
    .stamp {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem; /* Reduced font size for consistency */
        font-weight: bold;
        padding: 0.2rem 0.4rem; /* Smaller padding */
        border: 1px solid currentColor; /* Keep border consistent */
        border-radius: 20px; /* Adjusted for a smaller appearance */
        text-transform: uppercase;
        box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1); /* Lighter shadow */
        letter-spacing: 0.5px;
        width: auto; /* Ensure consistent size */
    }
    
    .stamp.bg-success {
        color: #28a745; /* Green color for success */
        background-color: #d4edda;
    }
    
    .stamp.bg-warning {
        color: #ffc107; /* Yellow color for pending */
        background-color: #fff3cd;
    }
    
    .stamp svg {
        margin-right: 0.2rem; /* Adjusted spacing between icon and text */
        width: 12px; /* Smaller icon size */
        height: 12px;
    }
    
    @media print {
    /* Hide elements you don't want to print */
    .dropdown, .dropdown-menu, .btn, .navbar, .header, .footer {
        display: none !important;
    }

    /* Ensure content such as tables and vouchers are displayed */
    body {
        font-size: 12pt;
        margin: 1in;
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    th, td {
        border: 1px solid black;
        padding: 8px;
        text-align: left;
    }

    h2 {
        text-align: center;
    }
}
    /* Ensure the table doesn't stretch too wide */
.table-responsive {
    -webkit-overflow-scrolling: touch;
    overflow-x: auto;
}

/* Optional: Make the table columns wrap and prevent long content from breaking the layout */
.table td, .table th {
    word-wrap: break-word;
    word-break: break-word;
    white-space: normal;
}

/* On larger screens, the table should not exceed the container-fluid's width */
@media (min-width: 768px) {
    .table-responsive {
        overflow-x: auto;
    }
}
    /* General Styles */
    #filterSection {
        margin-top: 10px;
    }

    #filterContainer {
        max-height: 160px;
        overflow: hidden;
    }

    #filterContainer.open {
        max-height: 400px;
        overflow-y: auto;
    }

    /* Mobile Responsive Styles */
    @media (max-width: 767px) {
        .container-fluid {
            padding-left: 15px;
            padding-right: 15px;
        }

        .d-flex.justify-content-between {
            flex-direction: column;
            align-items: flex-start;
        }

        .d-flex.align-items-center.mb-4 {
            margin-bottom: 20px;
        }

        .d-flex.align-items-center.mb-3 {
            margin-bottom: 20px;
        }

        .d-flex.align-items-center.mb-4.ms-2 {
            margin-top: 10px;
        }

        #filterSection {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            margin-top: 10px;
        }

        #filterDateButton {
            margin-bottom: 10px;
            width: 100%;
        }

        #filterContainer {
            width: 100%;
            display: block;
        }

        #dateFields {
            display: block;
            gap: 5px;
            width: 100%;
        }

        #dateFields .form-control {
            width: 100%;
            margin-right: 0;
        }

        #applyFilterButton {
            width: 100%;
        }

        .input-group-text {
            width: 35px;
        }

        .table-responsive {
            margin-top: 20px;
        }

        table {
            font-size: 12px;
        }

        th, td {
            padding: 5px;
        }
    }

    /* Desktop and Tablet Responsive Styles */
    @media (min-width: 768px) {
        #dateFields {
            display: flex;
        }

        #dateFields .form-control {
            margin-right: 10px;
            margin-bottom: 0;
        }

        #applyFilterButton {
            display: inline-block;
        }
    }

    /* Styling for Filter Container when expanded */
    .filter-container-open {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
</style>
{% endblock %}