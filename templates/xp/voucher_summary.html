{% extends 'base.html' %}

{% block content %}
<div class="container-fluid mt-5">
    <!-- Search Form below the navbar -->
    <div class="d-flex justify-content-between mb-3">
        <!-- Export Buttons and User Selection (Visible only for admin) -->
        <div class="d-flex gap-3">
            <!-- Export Dropdown -->
            <div class="dropdown">
                <button class="btn btn-primary dropdown-toggle" type="button" id="exportDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    Export
                </button>
                <ul class="dropdown-menu" aria-labelledby="exportDropdown">
                    <li>
                        <a class="dropdown-item" href="{% url 'transaction' %}?{{ request.GET.urlencode }}&export=csv">
                          Export CSV
                        </a>
                      </li>
                      <li>
                        <a class="dropdown-item" href="{% url 'transaction' %}?{{ request.GET.urlencode }}&export=xlsx">
                          Export XLSX
                        </a>
                      </li>
                      <li>
                        <a class="dropdown-item" href="{% url 'transaction' %}?{{ request.GET.urlencode }}&export=pdf">
                          Export PDF
                        </a>
                      </li>
                      <!-- Modal Export Button -->
                        <li>
                            <button class="dropdown-item text-primary" data-bs-toggle="modal" data-bs-target="#customExportModal">
                            ðŸ“… Custom Date Range
                            </button>
                        </li>
                </ul>
                <div class="modal fade" id="customExportModal" tabindex="-1" aria-labelledby="customExportModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                      <form method="get" action="{% url 'transaction' %}" class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title" id="customExportModalLabel">Export by Filters</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                  
                        <div class="modal-body">
                          <!-- Format dropdown -->
                          <div class="mb-3">
                            <label for="exportFormat" class="form-label">Select Format</label>
                            <select name="export" class="form-select" id="exportFormat" required>
                              <option value="xlsx">Excel (XLSX)</option>
                              <option value="csv">CSV</option>
                              <option value="pdf">PDF</option>
                            </select>
                          </div>
                  
                          <!-- Date filters -->
                          <div class="mb-3">
                            <label for="from" class="form-label">From Date</label>
                            <input type="date" name="transaction_date_from" class="form-control" required>
                          </div>
                  
                          <div class="mb-3">
                            <label for="to" class="form-label">To Date</label>
                            <input type="date" name="transaction_date_to" class="form-control" required>
                          </div>
                  
                          <!-- Item Type filter -->
                          
                        </div>
                  
                        <div class="modal-footer">
                          <button type="submit" class="btn btn-success">Export</button>
                        </div>
                      </form>
                    </div>
                  </div>
            </div>

            {% if user.is_staff %}
            <!-- User Dropdown for Admin -->
            <form method="get" class="d-flex">
                <div class="dropdown">
                    <a href="#" class="btn btn-primary dropdown-toggle d-flex align-items-center gap-2 justify-content-center" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false" >
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="color: white" class="icon icon-tabler icon-tabler-user">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                            <path d="M12 2a5 5 0 1 1 -5 5l.005 -.217a5 5 0 0 1 4.995 -4.783z" fill="white" />
                            <path d="M14 14a5 5 0 0 1 5 5v1a2 2 0 0 1 -2 2h-10a2 2 0 0 1 -2 -2v-1a5 5 0 0 1 5 -5h4z" fill="white" />
                        </svg>
                        <span class="text-white" style="font-size: 14px"> User </span>
                    </a>
                    <ul class="dropdown-menu" aria-labelledby="userDropdown">
                        <li>
                            <a class="dropdown-item" href="?user_id=" >--Select User--</a>
                        </li>
                        {% for user in users %}
                            <li>
                                <a class="dropdown-item" href="?user_id={{ user.id }}&transaction_date_from={{ transaction_date_from }}&transaction_date_to={{ transaction_date_to }}&item_type={{ item_type_filter }}&search={{ search_query }}"
                                {% if user.id == selected_user_id %} class="active" {% endif %}>
                                    {{ user.username }}
                                </a>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </form>

            <!-- Clear Button for Admin -->
            <a href="{% url 'transaction' %}" class="btn btn-secondary">Clear</a>
            {% endif %}
        </div>
    
        <!-- Search Form on the right -->
        {% comment %} <form method="GET" class="d-flex w-auto">
            <input type="text" name="search" value="{{ search_query }}" class="form-control w-20" placeholder="Search..." />
            <button type="submit" class="btn btn-primary ms-2">Search</button>
            <!-- Clear Button -->
            <a href="{% url 'transaction' %}" class="btn btn-secondary ms-2">Clear</a>
        </form> {% endcomment %}
    </div>

    <div class="table-responsive shadow-sm rounded border">
        <table class="table table-striped table-hover align-middle">
            <thead class="table-dark">
                <tr>
                    <th style="width: 20%; border: 1px solid #ddd; padding: 8px;">Transaction</th>
                    <th style="width: 15%; border: 1px solid #ddd; padding: 8px;">Initial Advance</th>
                    <th style="width: 15%; border: 1px solid #ddd; padding: 8px;">Credit</th>
                    <th style="width: 15%; border: 1px solid #ddd; padding: 8px;">Debit</th>
                    <th style="width: 15%; border: 1px solid #ddd; padding: 8px;">Remaining Advance</th>
                    <th style="width: 15%; border: 1px solid #ddd; padding: 8px;">Balance</th>
                </tr>
            </thead>
            <tbody>
                {% for item in summary_data %}
                    <tr>
                        <td class="text-center" style="border: 1px solid #ddd; padding: 8px;">{{ item.summary }}</td>
                        <td class="text-center" style="border: 1px solid #ddd; padding: 8px;">{{ item.advance }}</td>
                        <td class="text-center" style="border: 1px solid #ddd; padding: 8px;">{{ item.credit }}</td>
                        <td class="text-center" style="border: 1px solid #ddd; padding: 8px;">{{ item.debit }}</td>
                        <td class="text-center" style="border: 1px solid #ddd; padding: 8px;">{{ item.advance }}</td>
                        <td class="text-center" style="border: 1px solid #ddd; padding: 8px;">{{ item.balance }}</td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="6" class="text-center text-muted">No records found.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    {% comment %} {% if payment_details %}
        <h3 class="mt-4">Payment Details</h3>
        <div class="table-responsive shadow-sm rounded border">
            <table class="table">
                <thead>
                    <tr>
                        <th>Transaction ID</th>
                        <th>User</th>
                        <th>Amount</th>
                        <th>From</th>
                        <th>To</th>
                        <th>Screenshot</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>{{ payment_details.transaction_id }}</td>
                        <td>{{ selected_user.username }}</td>
                        <td>{{ payment_details.amount }}</td>
                        <td>{{ payment_details.from_date }}</td>
                        <td>{{ payment_details.to_date }}</td>
                        <td>
                            {% if payment_details.screenshot %}
                                <a href="{{ payment_details.screenshot.url }}" target="_blank">View Screenshot</a>
                            {% else %}
                                No screenshot uploaded
                            {% endif %}
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    {% endif %} {% endcomment %}
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    // Handle click on dropdown items
    $('.dropdown-item').on('click', function () {
        $(this).closest('.dropdown-menu').removeClass('show');  // Hide the dropdown after selection
    });
});
</script>
{% endblock %}