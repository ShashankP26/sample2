{% extends "base.html" %}

{% block content %}
<!-- <script src="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta14/dist/js/tabler.min.js"></script> -->
<div class="container-fluid mt-5">
    <h2>Create Commercial Quote</h2><br>
    <p><strong>Enquiry ID:</strong> {{ enquiry_id }}</p>

    <form method="POST">
        {% csrf_token %}
        
        <!-- Quotation Number (Generated) -->
        <div class="mb-3">
            <label for="quotation_no" class="form-label">Quotation Number</label>
            <input type="text" class="form-control" id="quotation_no" name="quotation_no" value="{{ quotation_no }}" readonly>
        </div>
    
      <!-- Bill To and Ship To (Side-by-side using Bootstrap grid) -->
        <div class="row">
            <!-- Bill To -->
            <div class="col-md-6">
                <h4>Bill To</h4>
                <table class="table">
                    <tbody>
                        <tr>
                            <th>Company Name</th>
                            <td><input type="text" class="form-control" name="bill_to_company_name" value="{{ form.companyname.value }}" required></td>
                        </tr>
                        <tr>
                            <th>Customer Name</th>
                            <td><input type="text" class="form-control" name="bill_to_customer_name" value="{{ form.customername.value }}" required></td>
                        </tr>
                        <tr>
                            <th>GST Number</th>
                            <td><input type="text" class="form-control" name="bill_to_gst_number" id="bill_to_gst_number" value="{{ form.gst_number.value }}" required></td>
                        </tr>
                        <tr>
                            <th>Address</th>
                            <td><textarea class="form-control" name="bill_to_address" rows="3" required>{{ form.address.value }}</textarea></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <!-- Ship To -->
            <div class="col-md-6">
                <h4>Ship To</h4>
                <table class="table">
                    <tbody>
                        <tr>
                            <th>Company Name</th>
                            <td><input type="text" class="form-control" name="ship_to_company_name" value="{{ form.companyname.value }}" required></td>
                        </tr>
                        <tr>
                            <th>Customer Name</th>
                            <td><input type="text" class="form-control" name="ship_to_customer_name" value="{{ form.customername.value }}" required></td>
                        </tr>
                        <tr>
                            <th>GST Number</th>
                            <td><input type="text" class="form-control" name="ship_to_gst_number" value="{{ form.gst_number.value }}" required></td>
                        </tr>
                        <tr>
                            <th>Address</th>
                            <td><textarea class="form-control" name="ship_to_address" rows="3" required>{{ form.address.value }}</textarea></td>
                        </tr>
                    </tbody>
                </table>
            </div>
                <div class="container-fluid mt-4">
                    <!-- From and Terms & Conditions (Side-by-side) -->
                    <div class="row">
                        <!-- From Section -->
                        <div class="col-md-6">
                            <h4>From</h4>
                            <table class="table table-bordered">
                                <tbody>
                                    <tr>
                                        <th>Company Name</th>
                                        <td><input type="text" class="form-control" name="from_company_name" value="{{ xpredict.company_name }}" ></td>
                                    </tr>
                                    <tr>
                                        <th>Phone Number</th>
                                        <td><input type="text" class="form-control" name="from_phone" value="{{ xpredict.phone_no }}" readonly></td>
                                    </tr>
                                    <tr>
                                        <th>Email</th>
                                        <td><input type="text" class="form-control" name="from_email" value="{{ xpredict.mail }}" readonly></td>
                                    </tr>
                                    <tr>
                                        <th>GST Number</th>
                                        <td><input type="text" class="form-control" name="from_gst" id="from_gst" value="{{ xpredict.gst }}" readonly></td>
                                    </tr>
                                    <tr>
                                        <th>Pan Number</th>
                                        <td><input type="text" class="form-control" name="from_pan" value="{{ xpredict.pan }}" ></td>
                                    </tr>
                                    <tr>
                                        <th>Address</th>
                                        <td><textarea class="form-control" name="from_address" rows="3" readonly>{{ xpredict.address }}</textarea></td>
                                    </tr>
                                    <tr>
                                        <th>Bank Details</th>
                                        <td>
                                            <select name="bank_id" id="bank_id" class="form-select">
                                                <option value="" selected disabled>Select Bank</option>
                                                {% for bank in banks %}
                                                    <option value="{{ bank.id }}">{{ bank.bank_name }} - {{ bank.account_number }}</option>
                                                {% endfor %}
                                            </select>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                
                        <!-- Terms & Conditions Section -->
                        <div class="col-md-6">
                            <h4>Terms & Conditions</h4>
                            <textarea class="form-control" name="terms_and_conditions" rows="15" required>{{ xpredict.terms_conditions }}</textarea>
                        </div>
                    </div>
                
                    <!-- Table for Item Details -->
                    <div id="table-default" class="table-responsive">

                        <h4>Item Details</h4>
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Sl. No.</th>
                                    <th>Description</th>
                                    <th>HSN code</th>
                                    <th>Base Amount</th>
                                    <th>Quantity</th>
                                    <th>Margin %</th>
                                    <th>Rate</th>
                                    <th>CGST (%)</th>
                                    <th>SGST (%)</th>
                                    <th>IGST (%)</th>
                                    <th>Final Amount</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="item-table">
                                <!-- Example Row -->
                                <tr>
                                    <td>1</td>
                                    <td>
                                        <select class="form-select" name="products[]" required onchange="updateProductDetails(this)">
                                            <option value="" disabled selected>Select a product</option>
                                            {% for product in products %}
                                            <option value="{{ product.id }}" data-hsncode="{{ product.hsncode }}" data-base_amount="{{ product.base_amount }}" data-gst="{{ product.gst }}">
                                                {{ product.name }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </td>
                                    <td><input type="text" class="form-control" name="hsncode[]" readonly></td>
                                    <td><input type="text" class="form-control" name="base_amount[]" readonly></td>
                                    <td><input type="number" class="form-control" name="quantity[]" min="1" required oninput="updateRateAndFinalAmount(this)" style="width: 70px;"></td>
                                    <td><input type="number" class="form-control" name="margin[]" min="0" max="100" step="0.01" required oninput="updateRateAndFinalAmount(this)"></td>
                                    <td><input type="number" class="form-control" name="rate[]" readonly style="width: 120px;"></td>
                                    <td><input type="number" class="form-control" name="cgst[]" min="0" max="100" step="0.01" oninput="updateFinalAmount(this)" readonly></td>
                                    <td><input type="number" class="form-control" name="sgst[]" min="0" max="100" step="0.01" oninput="updateFinalAmount(this)" readonly></td>
                                    <td><input type="number" class="form-control" name="igst[]" min="0" max="100" step="0.01" oninput="updateFinalAmount(this)" readonly></td>
                                    <td><input type="number" class="form-control" name="final_amount[]" readonly></td>
                                    <td><button type="button" class="btn btn-danger remove-row">Remove</button></td>
                                </tr>
                            </tbody>
                        </table><br>
                        <button type="button" class="btn btn-success" id="add-row">Add Row</button>
                    </div>
                
                    <!-- Total Final Amount (Including GST) -->
                    <div class="mt-4">
                        <h4>Total</h4>
                        <div class="row mb-1">
                            <div class="col-2">
                                <p><strong>Subtotal (Rates):</strong></p>
                                <div class="input-group input-group-sm">
                                    <input type="text" id="subtotal" name="subtotal" value="0.00" class="form-control text-end custcss" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="row mb-1">
                            <div class="col-2">
                                <p><strong>CGST:</strong></p>
                                <div class="input-group input-group-sm">
                                    <input type="text" id="cgst-total" name="cgst_total" value="0.00" class="form-control text-end custcss" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="row mb-1">
                            <div class="col-2">
                                <p><strong>SGST:</strong></p>
                                <div class="input-group input-group-sm">
                                    <input type="text" id="sgst-total" name="sgst_total" value="0.00" class="form-control text-end custcss" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="row mb-1">
                            <div class="col-2">
                                <p><strong>IGST:</strong></p>
                                <div class="input-group input-group-sm">
                                    <input type="text" id="igst-total" name="igst_total" value="0.00" class="form-control text-end custcss" readonly>
                                </div>
                            </div>
                        </div>
                            
                            <div class="col-2">
                                <p><strong>Grand Total:</strong></p>
                                <div class="input-group input-group-sm">
                                    <input type="text" id="grand-total" name="grand_total" value="0.00" class="form-control text-end custcss" readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    
                    
                    
                
                    <!-- Submit Button -->
                    <div class="mt-4 text-center">
                        <button type="submit" class="btn btn-primary">Save Quote</button>
                        

                    </div>
                </div>
            </div>
        </div>    
    </form>            


    <script>
        // Function to check GST numbers and enable/disable columns
        function checkGSTNumbers() {
            // Get Bill To and From GST numbers
            var billToGST = document.querySelector('input[name="bill_to_gst_number"]').value;
            var fromGST = document.querySelector('input[name="from_gst"]').value;
        
            // Ensure both GST numbers are available and valid
            if (billToGST && fromGST) {
                var billToPrefix = billToGST.substring(0, 2); // First two digits of Bill To GST
                var fromPrefix = fromGST.substring(0, 2); // First two digits of From GST
                
                // If prefixes match, disable IGST and enable CGST/SGST
                if (billToPrefix === fromPrefix) {
                    // Enable CGST and SGST, disable IGST
                    document.querySelectorAll('input[name="cgst[]"]').forEach(function(input) {
                        input.disabled = false;
                    });
                    document.querySelectorAll('input[name="sgst[]"]').forEach(function(input) {
                        input.disabled = false;
                    });
                    document.querySelectorAll('input[name="igst[]"]').forEach(function(input) {
                        input.disabled = true;
                        input.value = ''; // Clear IGST values if disabled
                    });
                } else {
                    // Enable IGST, disable CGST and SGST
                    document.querySelectorAll('input[name="cgst[]"]').forEach(function(input) {
                        input.disabled = true;
                        input.value = ''; // Clear CGST values if disabled
                    });
                    document.querySelectorAll('input[name="sgst[]"]').forEach(function(input) {
                        input.disabled = true;
                        input.value = ''; // Clear SGST values if disabled
                    });
                    document.querySelectorAll('input[name="igst[]"]').forEach(function(input) {
                        input.disabled = false;
                    });
                }
            }
        }
        
        // Run the GST check when the page loads and whenever the GST number fields are updated
        document.querySelector('input[name="bill_to_gst_number"]').addEventListener('input', checkGSTNumbers);
        document.querySelector('input[name="from_gst"]').addEventListener('input', checkGSTNumbers);
        
        // Initial check on page load
        checkGSTNumbers();
        
        // Function to update product details when a product is selected
        function updateProductDetails(selectElement) {
            var selectedOption = selectElement.options[selectElement.selectedIndex];
            var hsnCode = selectedOption.getAttribute('data-hsncode');
            var baseAmount = selectedOption.getAttribute('data-base_amount');
            var gst = parseFloat(selectedOption.getAttribute('data-gst')) || 0; // Get GST from product
            var row = selectElement.closest('tr');
            
            // Update the corresponding HSN code and base amount input fields
            var hsnCodeInput = row.querySelector('[name="hsncode[]"]');
            var baseAmountInput = row.querySelector('[name="base_amount[]"]');
            if (hsnCodeInput) hsnCodeInput.value = hsnCode;
            if (baseAmountInput) baseAmountInput.value = baseAmount;
        
            // Distribute GST between CGST/SGST or IGST
            var cgstInput = row.querySelector('[name="cgst[]"]');
            var sgstInput = row.querySelector('[name="sgst[]"]');
            var igstInput = row.querySelector('[name="igst[]"]');
        
            if (!cgstInput.disabled && !sgstInput.disabled) {
                // CGST and SGST fields are enabled
                cgstInput.value = (gst / 2).toFixed(2); // Divide GST into two halves
                sgstInput.value = (gst / 2).toFixed(2);
                igstInput.value = ''; // Clear IGST
            } else if (!igstInput.disabled) {
                // IGST field is enabled
                igstInput.value = gst.toFixed(2); // Fill full GST in IGST
                cgstInput.value = ''; // Clear CGST
                sgstInput.value = ''; // Clear SGST
            }
        
            // Recalculate the rate and final amount after updating the base amount
            updateRateAndFinalAmount(row.querySelector('[name="quantity[]"]'));
        }
        
        // Function to update rate and final amount based on quantity and margin
        function updateRateAndFinalAmount(inputElement) {
            var row = inputElement.closest('tr');
            var baseAmount = parseFloat(row.querySelector('[name="base_amount[]"]').value) || 0;
            var quantity = parseFloat(row.querySelector('[name="quantity[]"]').value) || 1;
            var margin = parseFloat(row.querySelector('[name="margin[]"]').value) || 0;
            
            // Calculate the rate based on quantity and margin
            var rate = (baseAmount * quantity) * (1 + margin / 100);
            row.querySelector('[name="rate[]"]').value = rate.toFixed(2);
        
            // Recalculate the final amount (including CGST, SGST, and IGST)
            updateFinalAmount(row.querySelector('[name="cgst[]"]'));
        }
        
        // Function to update final amount based on CGST, SGST, and IGST
        function updateFinalAmount(inputElement) {
            var row = inputElement.closest('tr');
            var rate = parseFloat(row.querySelector('[name="rate[]"]').value) || 0;
            var cgstPercent = parseFloat(row.querySelector('[name="cgst[]"]').value) || 0;
            var sgstPercent = parseFloat(row.querySelector('[name="sgst[]"]').value) || 0;
            var igstPercent = parseFloat(row.querySelector('[name="igst[]"]').value) || 0;
            
            // Calculate CGST, SGST, IGST, and Final Amount
            var cgstAmount = (rate * cgstPercent) / 100;
            var sgstAmount = (rate * sgstPercent) / 100;
            var igstAmount = (rate * igstPercent) / 100;
            var finalAmount = rate + cgstAmount + sgstAmount + igstAmount;
        
            row.querySelector('[name="final_amount[]"]').value = finalAmount.toFixed(2);
        
            updateTotalFinalAmount(); // Recalculate total final amount
        }
        
        // Add row functionality
        document.getElementById("add-row").addEventListener("click", function() {
            const table = document.getElementById("item-table");
            const rowCount = table.querySelectorAll("tr").length + 1; // Adjusted to handle headers
            const row = `
                <tr>
                    <td>${rowCount}</td>
                    <td>
                        <select class="form-select" name="products[]" required onchange="updateProductDetails(this)">
                            <option value="" disabled selected>Select a product</option>
                            {% for product in products %}
                                <option value="{{ product.id }}" 
                                        data-hsncode="{{ product.hsncode }}" 
                                        data-base_amount="{{ product.base_amount }}"
                                        data-gst="{{ product.gst }}"> <!-- Include GST attribute -->
                                    {{ product.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </td>
                    <td><input type="text" class="form-control" name="hsncode[]" readonly></td>
                    <td><input type="text" class="form-control" name="base_amount[]" readonly></td>
                    <td><input type="number" class="form-control" name="quantity[]" min="1" required oninput="updateRateAndFinalAmount(this)" style="width: 70px;"></td>
                    <td><input type="number" class="form-control" name="margin[]" min="0" max="100" step="0.01" required oninput="updateRateAndFinalAmount(this)"></td>
                    <td><input type="number" class="form-control" name="rate[]" readonly style="width: 120px;"></td>
                    <td><input type="number" class="form-control" name="cgst[]" min="0" max="100" step="0.01" oninput="updateFinalAmount(this)" readonly></td>
                    <td><input type="number" class="form-control" name="sgst[]" min="0" max="100" step="0.01" oninput="updateFinalAmount(this)" readonly></td>
                    <td><input type="number" class="form-control" name="igst[]" min="0" max="100" step="0.01" oninput="updateFinalAmount(this)" readonly></td>
                    <td><input type="number" class="form-control" name="final_amount[]" readonly></td>
                    <td><button type="button" class="btn btn-danger remove-row">Remove</button></td>
                </tr>
            `;
            table.insertAdjacentHTML('beforeend', row);
        
            // Reapply GST check logic for the new row
            checkGSTNumbers();
        
            // Update row numbering dynamically after adding a new row
            updateRowNumbers();
        });
        
        // Remove row functionality
        document.addEventListener("click", function(event) {
            if (event.target && event.target.classList.contains("remove-row")) {
                const row = event.target.closest("tr");
                row.remove();
                updateRowNumbers(); // Adjust row numbers after a row is removed
                updateTotalFinalAmount(); // Recalculate total final amount
            }
        });
        
        // Update row numbers after adding/removing rows
        function updateRowNumbers() {
            const rows = document.querySelectorAll("#item-table tr");
            let count = 1;
            rows.forEach(function(row) {
                const td = row.querySelector("td:first-child");
                if (td) {
                    td.textContent = count++;
                }
            });
        }
        
            // Function to calculate total final amount
            function updateTotalFinalAmount() {
                let subtotal = 0;
                let cgstTotal = 0;
                let sgstTotal = 0;
                let igstTotal = 0;
                let grandTotal = 0;

                document.querySelectorAll('[name="rate[]"]').forEach(function(input) {
                    const rate = parseFloat(input.value) || 0;
                    console.log(rate);
                    
                    subtotal += rate;
                });

                document.querySelectorAll('[name="cgst[]"]').forEach(function(input, index) {
                    const cgstPercentage = parseFloat(input.value) || 0;
                    const rate = parseFloat(document.querySelectorAll('[name="rate[]"]')[index].value) || 0;
                    cgstTotal += (rate * cgstPercentage) / 100;
                });

                document.querySelectorAll('[name="sgst[]"]').forEach(function(input, index) {
                    const sgstPercentage = parseFloat(input.value) || 0;
                    const rate = parseFloat(document.querySelectorAll('[name="rate[]"]')[index].value) || 0;
                    sgstTotal += (rate * sgstPercentage) / 100;
                });

                document.querySelectorAll('[name="igst[]"]').forEach(function(input, index) {
                    const igstPercentage = parseFloat(input.value) || 0;
                    const rate = parseFloat(document.querySelectorAll('[name="rate[]"]')[index].value) || 0;
                    igstTotal += (rate * igstPercentage) / 100;
                });

                grandTotal = subtotal + cgstTotal + sgstTotal + igstTotal;

                // Update the total fields
                document.querySelector("#subtotal").value = subtotal.toFixed(2);
                document.querySelector("#cgst-total").value = cgstTotal.toFixed(2);
                document.querySelector("#sgst-total").value = sgstTotal.toFixed(2);
                document.querySelector("#igst-total").value = igstTotal.toFixed(2);
                document.querySelector("#grand-total").value = grandTotal.toFixed(2);
            }

        
        </script>


<style>
.custcss{
    border: none;          /* Remove the border */
    background-color: transparent; /* Make the background transparent */
    text-align: left;     /* Right-align the text */
    width: 200px;          /* Optional: adjust the width if needed */
    padding: 1px;          /* Optional: add padding for better spacing */
    font-size: 14px;       /* Optional: adjust font size */
    color: #000;           /* Optional: change text color */
}
</style>

{% endblock %}
