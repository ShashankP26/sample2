{% extends "base.html" %}

{% block content %}

<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css" rel="stylesheet">
<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>

<div class="container mt-5">
    <h2>Create Commercial Quote</h2><br>
    <p><strong>Enquiry ID:</strong> {{ enquiry_id }}</p>

    <form method="POST">
        {% csrf_token %}

        <!-- Quotation Number (Generated) -->
        <div class="mb-3">
            <label for="quotation_no" class="form-label">Quotation Number</label>
            <input type="text" class="form-control" id="quotation_no" name="quotation_no" value="{{ quotation_no }}"
                readonly>
        </div>

        <!-- Bill To and Ship To (Side-by-side using Bootstrap grid) -->
        <div class="row">
            <!-- Bill To -->
            <div class="col-md-6">
                <h4>Bill To</h4>
                <table class="table">
                    <tbody>
                        <tr>
                            <th>Company Name</th>
                            <td><input type="text" class="form-control" name="bill_to_company_name"
                                    value="{{ form.companyname.value }}" required></td>
                        </tr>
                        <tr>
                            <th>Customer Name</th>
                            <td><input type="text" class="form-control" name="bill_to_customer_name"
                                    value="{{ form.customername.value }}" required></td>
                        </tr>
                        <tr>
                            <th>GST Number</th>
                            <td><input type="text" class="form-control" name="bill_to_gst_number"
                                    id="bill_to_gst_number" value="{{ form.gst_number.value }}" required
                                    onchange="updateProductDetails(this)"></td>
                        </tr>
                        <tr>
                            <th>Address</th>
                            <td><textarea class="form-control" name="bill_to_address" rows="3"
                                    required>{{ form.address.value }}</textarea></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <!-- Ship To -->
            <div class="col-md-6">
                <h4>Ship To</h4>
                <table class="table">
                    <tbody>
                        <tr>
                            <th>Company Name</th>
                            <td><input type="text" class="form-control" name="ship_to_company_name"
                                    value="{{ form.companyname.value }}" required></td>
                        </tr>
                        <tr>
                            <th>Customer Name</th>
                            <td><input type="text" class="form-control" name="ship_to_customer_name"
                                    value="{{ form.customername.value }}" required></td>
                        </tr>
                        <tr>
                            <th>GST Number</th>
                            <td><input type="text" class="form-control" name="ship_to_gst_number"
                                    value="{{ form.gst_number.value }}" required></td>
                        </tr>
                        <tr>
                            <th>Address</th>
                            <td><textarea class="form-control" name="ship_to_address" rows="3"
                                    required>{{ form.address.value }}</textarea></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="container mt-4">
                <!-- From and Terms & Conditions (Side-by-side) -->
                <div class="row">
                    <!-- From Section -->
                    <div class="col-md-6">
                        <h4>From</h4>
                        <table class="table table-bordered">
                            <tbody>
                                <tr>
                                    <th>Company Name</th>
                                    <td><input type="text" class="form-control" name="from_company_name"
                                            value="{{ xpredict.company_name }}"></td>
                                </tr>
                                <tr>
                                    <th>Phone Number</th>
                                    <td><input type="text" class="form-control" name="from_phone"
                                            value="{{ xpredict.phone_no }}" readonly></td>
                                </tr>
                                <tr>
                                    <th>Email</th>
                                    <td><input type="text" class="form-control" name="from_email"
                                            value="{{ xpredict.mail }}" readonly></td>
                                </tr>
                                <tr>
                                    <th>GST Number</th>
                                    <td><input type="text" class="form-control" name="from_gst" id="from_gst"
                                            value="{{ xpredict.gst }}" readonly></td>
                                </tr>
                                <tr>
                                    <th>Pan Number</th>
                                    <td><input type="text" class="form-control" name="from_pan"
                                            value="{{ xpredict.pan }}"></td>
                                </tr>
                                <tr>
                                    <th>Address</th>
                                    <td><textarea class="form-control" name="from_address" rows="3"
                                            readonly>{{ xpredict.address }}</textarea></td>
                                </tr>
                                <tr>
                                    <th>Bank Details
                                        <span style="color: red;">*</span>
                                    </th>
                                    <td>
                                        <label for="bank_id" class="form-label">

                                        </label>
                                        <select name="bank_id" id="bank_id" class="form-select" required>
                                            <option value="" selected disabled>Select Bank</option>
                                            {% for bank in banks %}
                                            <option value="{{ bank.id }}">{{ bank.bank_name }}
                                            </option>
                                            {% endfor %}
                                        </select>

                                    </td>

                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Terms & Conditions Section -->
                    <div class="col-md-6">
                        <h4>Terms & Conditions</h4>
                        <textarea class="form-control" name="terms_and_conditions" rows="15"
                            required>{{ xpredict.terms_conditions }}</textarea>
                    </div>
                </div>

                <!-- Table for Item Details -->
                <div id="table-default" class="table-responsive">

                    <h4>Item Details</h4>
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Sl. No.</th>
                                <th>Description</th>
                                <th>HSN code</th>
                                <th>Base Amount</th>
                                <th>Quantity</th>
                                <th>Margin %</th>
                                <th>Rate</th>
                                <th>CGST (%)</th>
                                <th>SGST (%)</th>
                                <th>IGST (%)</th>
                                <th>Final Amount</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="item-table">
                            <tr>
                                <td>1</td>
                                <td>
                                    <select class="form-select product-select" name="products[]" required
                                        onchange="updateProductDetails(this)">
                                        <option value="" disabled selected>Select a product</option>
                                        {% for product in products %}
                                        <option value="{{ product.id }}" data-hsncode="{{ product.hsncode }}"
                                            data-base_amount="{{ product.base_amount }}" data-gst="{{ product.gst }}">
                                            {{ product.name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <td><input type="text" class="form-control" name="hsncode[]" readonly></td>
                                <td><input type="text" class="form-control" name="base_amount[]" readonly></td>
                                <td><input type="number" class="form-control" name="quantity[]" min="1" required
                                        onchange="updateRateAndFinalAmount(this)" style="width: 70px;"></td>
                                <td><input type="number" class="form-control" name="margin[]" min="0" max="100"
                                        step="0.01" required onchange="updateRateAndFinalAmount(this)"></td>
                                <td><input type="number" class="form-control" name="rate[]" readonly
                                        style="width: 120px;"></td>
                                <td><input type="number" class="form-control" name="cgst[]" min="0" max="100"
                                        step="0.01" onchange="updateFinalAmount(this)" readonly></td>
                                <td><input type="number" class="form-control" name="sgst[]" min="0" max="100"
                                        step="0.01" onchange="updateFinalAmount(this)" readonly></td>
                                <td><input type="number" class="form-control" name="igst[]" min="0" max="100"
                                        step="0.01" onchange="updateFinalAmount(this)" readonly></td>
                                <td><input type="number" class="form-control" name="final_amount[]" readonly></td>
                                <td>
                                    <div class="d-flex gap-2">
                                        <button type="button" class="btn btn-success add-product">Add Product</button>
                                        <button type="button" class="btn btn-danger remove-row">Remove</button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table><br>
                    <button type="button" class="btn btn-success" id="add-row">Add Row</button>
                </div>

                <!-- Total Final Amount (Including GST) -->
                <div class="mt-4">
                    <h4>Total</h4>
                    <div class="row mb-1">
                        <div class="col-2">
                            <p><strong>Subtotal (Rates):</strong></p>
                            <div class="input-group input-group-sm">
                                <input type="text" id="subtotal" name="subtotal" value="0.00"
                                    class="form-control text-end custcss" readonly>
                            </div>
                        </div>
                    </div>
                    <div class="row mb-1">
                        <div class="col-2">
                            <p><strong>CGST:</strong></p>
                            <div class="input-group input-group-sm">
                                <input type="text" id="cgst-total" name="cgst_total" value="0.00"
                                    class="form-control text-end custcss" readonly>
                            </div>
                        </div>
                    </div>
                    <div class="row mb-1">
                        <div class="col-2">
                            <p><strong>SGST:</strong></p>
                            <div class="input-group input-group-sm">
                                <input type="text" id="sgst-total" name="sgst_total" value="0.00"
                                    class="form-control text-end custcss" readonly>
                            </div>
                        </div>
                    </div>
                    <div class="row mb-1">
                        <div class="col-2">
                            <p><strong>IGST:</strong></p>
                            <div class="input-group input-group-sm">
                                <input type="text" id="igst-total" name="igst_total" value="0.00"
                                    class="form-control text-end custcss" readonly>
                            </div>
                        </div>
                    </div>

                    <div class="col-2">
                        <p><strong>Grand Total:</strong></p>
                        <div class="input-group input-group-sm">
                            <input type="text" id="grand-total" name="grand_total" value="0.00"
                                class="form-control text-end custcss" readonly>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="mt-4 text-center">
                <button type="submit" class="btn btn-primary">Save Quote</button>
            </div>
        </div>
</div>
</div>
</form>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Function to enable/disable 'Add Product' button for a row
        function syncAddProductButton(row) {
            var select = row.querySelector('.product-select');
            var btn = row.querySelector('.add-product');
            if (select && btn) {
                // If a product is selected (value not empty/null/undefined), disable Add Product
                btn.disabled = !!select.value;
            }
        }
    
        // On page load, sync every row
        document.querySelectorAll("#item-table tr").forEach(syncAddProductButton);
    
        // Add Select2 to all existing selects
        $(".product-select").select2({
            tags: true,
            placeholder: "Search or type a product",
            allowClear: true,
            width: '180px'
        });
    
        // Listen for Select2 selection and clearing (also catches user clearing the field)
        $('#item-table').on('change', '.product-select', function() {
            syncAddProductButton(this.closest('tr'));
        });
    
        // When you add a new row, re-init Select2 and enable the Add Product button
        document.getElementById("add-row").addEventListener("click", function () {
            setTimeout(function() {
                var lastRow = document.querySelector("#item-table tr:last-child");
                syncAddProductButton(lastRow);
                // re-init Select2 on new select element
                var newSelect = lastRow.querySelector('.product-select');
                if (newSelect && !$(newSelect).data('select2')) {
                    $(newSelect).select2({
                        tags: true,
                        placeholder: "Search or type a product",
                        allowClear: true,
                        width: '180px'
                    });
                }
            }, 10);
        });
    });
    </script>
    
<script>
    /* --- YOUR EXISTING LOGIC IS KEPT --- */

    // Function to check GST numbers and enable/disable columns
    function checkGSTNumbers() {
        // ... (unchanged)
        var billToGST = document.querySelector('input[name="bill_to_gst_number"]').value;
        var fromGST = document.querySelector('input[name="from_gst"]').value;
        if (billToGST && fromGST) {
            var billToPrefix = billToGST.substring(0, 2);
            var fromPrefix = fromGST.substring(0, 2);
            if (billToPrefix === fromPrefix) {
                document.querySelectorAll('input[name="cgst[]"]').forEach(function (input) {
                    input.disabled = false;
                    input.value = '9.0';
                });
                document.querySelectorAll('input[name="sgst[]"]').forEach(function (input) {
                    input.disabled = false;
                    input.value = '9.0';
                });
                document.querySelectorAll('input[name="igst[]"]').forEach(function (input) {
                    input.disabled = true;
                    input.value = '';
                });
            } else {
                document.querySelectorAll('input[name="cgst[]"]').forEach(function (input) {
                    input.disabled = true;
                    input.value = '';
                });
                document.querySelectorAll('input[name="sgst[]"]').forEach(function (input) {
                    input.disabled = true;
                    input.value = '';
                });
                document.querySelectorAll('input[name="igst[]"]').forEach(function (input) {
                    input.disabled = false;
                    input.value = '18.0';
                });
            }
        }
    }

    // --- IMPROVEMENT: Centralized row update logic ---
    function updateRow(row) {
        let baseAmount = parseFloat(row.querySelector('[name="base_amount[]"]')?.value) || 0;
        let quantity = parseFloat(row.querySelector('[name="quantity[]"]')?.value) || 1;
        let margin = parseFloat(row.querySelector('[name="margin[]"]')?.value) || 0;
        let cgst = parseFloat(row.querySelector('[name="cgst[]"]')?.value) || 0;
        let sgst = parseFloat(row.querySelector('[name="sgst[]"]')?.value) || 0;
        let igst = parseFloat(row.querySelector('[name="igst[]"]')?.value) || 0;

        // Calculate rate (baseAmount * (1 + margin/100))
        let rate = baseAmount * (1 + margin / 100);
        row.querySelector('[name="rate[]"]').value = rate.toFixed(2);

        // Calculate final amount
        let finalAmount = rate * quantity;
        let cgstAmt = (finalAmount * cgst) / 100;
        let sgstAmt = (finalAmount * sgst) / 100;
        let igstAmt = (finalAmount * igst) / 100;
        let total = finalAmount + cgstAmt + sgstAmt + igstAmt;
        row.querySelector('[name="final_amount[]"]').value = total.toFixed(2);
    }

    // --- IMPROVEMENT: Centralized GST split logic ---
    function distributeGST(row, gst) {
        var billToGST = document.getElementById('bill_to_gst_number').value;
        var fromGST = document.querySelector('input[name="from_gst"]').value;

        var cgstInput = row.querySelector('[name="cgst[]"]');
        var sgstInput = row.querySelector('[name="sgst[]"]');
        var igstInput = row.querySelector('[name="igst[]"]');

        if (billToGST && fromGST) {
            var billToPrefix = billToGST.substring(0, 2);
            var fromPrefix = fromGST.substring(0, 2);

            if (billToPrefix === fromPrefix) {
                cgstInput.disabled = false; sgstInput.disabled = false; igstInput.disabled = true;
                cgstInput.value = (gst / 2).toFixed(2);
                sgstInput.value = (gst / 2).toFixed(2);
                igstInput.value = "0.00";
            } else {
                cgstInput.disabled = true; sgstInput.disabled = true; igstInput.disabled = false;
                cgstInput.value = "0.00";
                sgstInput.value = "0.00";
                igstInput.value = gst.toFixed(2);
            }
        }
    }

    // --- YOUR EXISTING TOTAL CALCULATION LOGIC ---
    function updateTotalFinalAmount() {
        let subtotal = 0;
        let totalCGST = 0;
        let totalSGST = 0;
        let totalIGST = 0;

        document.querySelectorAll("#item-table tr").forEach(row => {
            let baseAmount = parseFloat(row.querySelector("[name='base_amount[]']")?.value) || 0;
            let quantity = parseFloat(row.querySelector("[name='quantity[]']")?.value) || 1;
            let margin = parseFloat(row.querySelector("[name='margin[]']")?.value) || 0;
            let cgst = parseFloat(row.querySelector("[name='cgst[]']")?.value) || 0;
            let sgst = parseFloat(row.querySelector("[name='sgst[]']")?.value) || 0;
            let igst = parseFloat(row.querySelector("[name='igst[]']")?.value) || 0;

            let rate = baseAmount * (1 + margin / 100);
            let finalAmount = rate * quantity;

            subtotal += finalAmount;
            totalCGST += (finalAmount * cgst) / 100;
            totalSGST += (finalAmount * sgst) / 100;
            totalIGST += (finalAmount * igst) / 100;
        });

        let grandTotal = subtotal + totalCGST + totalSGST + totalIGST;

        document.getElementById("subtotal").value = subtotal.toFixed(2);
        document.getElementById("cgst-total").value = totalCGST.toFixed(2);
        document.getElementById("sgst-total").value = totalSGST.toFixed(2);
        document.getElementById("igst-total").value = totalIGST.toFixed(2);
        document.getElementById("grand-total").value = grandTotal.toFixed(2);
    }

    // --- YOUR EXISTING PRODUCT DETAILS LOGIC ---
    function updateProductDetails(element) {
        if (element.name === "products[]") {
            var selectedOption = element.options[element.selectedIndex];
            var hsnCode = selectedOption.getAttribute('data-hsncode');
            var baseAmount = selectedOption.getAttribute('data-base_amount');
            var gst = parseFloat(selectedOption.getAttribute('data-gst')) || 0;
            var row = element.closest('tr');
            var hsnCodeInput = row.querySelector('[name="hsncode[]"]');
            var baseAmountInput = row.querySelector('[name="base_amount[]"]');
            if (hsnCodeInput) hsnCodeInput.value = hsnCode;
            if (baseAmountInput) baseAmountInput.value = baseAmount;
            distributeGST(row, gst);
            updateRow(row);
            updateTotalFinalAmount();
        } else if (element.name === "bill_to_gst_number") {
            document.querySelectorAll('select[name="products[]"]').forEach(function (productSelect) {
                var row = productSelect.closest('tr');
                var gst = parseFloat(productSelect.options[productSelect.selectedIndex].getAttribute('data-gst')) || 0;
                distributeGST(row, gst);
                updateRow(row);
            });
            updateTotalFinalAmount();
        }
    }

    // --- YOUR EXISTING RATE/FINAL AMOUNT LOGIC ---
    function updateRateAndFinalAmount(inputElement) {
        var row = inputElement.closest('tr');
        updateRow(row);
        updateTotalFinalAmount();
    }

    function updateFinalAmount(inputElement) {
        var row = inputElement.closest('tr');
        updateRow(row);
        updateTotalFinalAmount();
    }

    // --- ENHANCED EVENT DELEGATION FOR DYNAMIC ROWS ---
    document.addEventListener("DOMContentLoaded", function () {
        const table = document.getElementById("item-table");

        // Add product button logic (unchanged)
        table.addEventListener("click", function (event) {
            if (event.target.classList.contains("add-product")) {
                let row = event.target.closest("tr");
                let selectBox = row.querySelector(".product-select");
                if (selectBox) {
                    let selectedValue = selectBox.value;
                    if ($(selectBox).data('select2')) {
                        $(selectBox).select2('destroy');
                    }
                    let select2Container = row.querySelector(".select2-container");
                    if (select2Container) {
                        select2Container.remove();
                    }
                    let newInput = document.createElement("input");
                    newInput.type = "text";
                    newInput.className = "form-control";
                    newInput.name = "products[]";
                    newInput.placeholder = "Enter Product Name";
                    newInput.required = true;
                    newInput.value = selectedValue;
                    selectBox.replaceWith(newInput);
                }
                row.querySelectorAll("input[name='hsncode[]'], input[name='base_amount[]'], input[name='cgst[]'], input[name='sgst[]'], input[name='igst[]']")
                    .forEach(input => input.removeAttribute("readonly"));
                event.target.remove();
            }
        });

        // Remove row functionality (unchanged)
        document.addEventListener("click", function (event) {
            if (event.target && event.target.classList.contains("remove-row")) {
                event.target.closest("tr").remove();
                updateRowNumbers();
                updateTotalFinalAmount();
            }
        });

        // Add row functionality (unchanged, but triggers GST logic for new row)
        document.getElementById("add-row").addEventListener("click", function () {
            const rowCount = document.querySelectorAll("#item-table tr").length + 1;
            const row = `
        <tr>
            <td>${rowCount}</td>
            <td>
                <select class="form-select product-select" name="products[]" required onchange="updateProductDetails(this)">
                    <option value="" disabled selected>Select a product</option>
                    {% for product in products %}
                        <option value="{{ product.id }}" 
                                data-hsncode="{{ product.hsncode }}" 
                                data-base_amount="{{ product.base_amount }}"
                                data-gst="{{ product.gst }}">
                            {{ product.name }}
                        </option>
                    {% endfor %}
                </select>
            </td>
            <td><input type="text" class="form-control" name="hsncode[]" readonly></td>
            <td><input type="text" class="form-control" name="base_amount[]" readonly></td>
            <td><input type="number" class="form-control" name="quantity[]" min="1" required onchange="updateRateAndFinalAmount(this)" style="width: 70px;"></td>
            <td><input type="number" class="form-control" name="margin[]" min="0" max="100" step="0.01" required onchange="updateRateAndFinalAmount(this)"></td>
            <td><input type="number" class="form-control" name="rate[]" readonly style="width: 120px;"></td>
            <td><input type="number" class="form-control" name="cgst[]" min="0" max="100" step="0.01" onchange="updateFinalAmount(this)" readonly></td>
            <td><input type="number" class="form-control" name="sgst[]" min="0" max="100" step="0.01" onchange="updateFinalAmount(this)" readonly></td>
            <td><input type="number" class="form-control" name="igst[]" min="0" max="100" step="0.01" onchange="updateFinalAmount(this)" readonly></td>
            <td><input type="number" class="form-control" name="final_amount[]" readonly></td>
            <td>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-success add-product">Add Product</button>
                    <button type="button" class="btn btn-danger remove-row">Remove</button>
                </div>
            </td>
        </tr>
        `;
            table.insertAdjacentHTML('beforeend', row);
            $(".product-select").last().select2({
                tags: true,
                placeholder: "Search or type a product",
                allowClear: true,
                width: '180px'
            });
            checkGSTNumbers();
            updateRowNumbers();
        });

        // Initialize Select2 on page load (unchanged)
        $(document).ready(function () {
            $(".product-select").select2({
                tags: true,
                placeholder: "Search or type a product",
                allowClear: true,
                width: '180px'
            });
        });

        // Update row numbers dynamically (unchanged)
        function updateRowNumbers() {
            const rows = document.querySelectorAll("#item-table tr");
            let count = 1;
            rows.forEach(function (row) {
                const td = row.querySelector("td:first-child");
                if (td) {
                    td.textContent = count++;
                }
            });
        }

        // --- NEW: Centralized event delegation for margin/quantity changes ---
        table.addEventListener("input", function (e) {
            if (e.target.name === "margin[]" || e.target.name === "quantity[]") {
                let row = e.target.closest('tr');
                updateRow(row);
                updateTotalFinalAmount();
            }
        });

        // --- NEW: Centralized event delegation for product selection ---
        table.addEventListener("change", function (e) {
            if (e.target.classList.contains('product-select')) {
                let row = e.target.closest('tr');
                let selected = e.target.options[e.target.selectedIndex];
                let hsn = selected.getAttribute('data-hsncode');
                let base = selected.getAttribute('data-base_amount');
                let gst = parseFloat(selected.getAttribute('data-gst')) || 0;
                row.querySelector('[name="hsncode[]"]').value = hsn;
                row.querySelector('[name="base_amount[]"]').value = base;
                distributeGST(row, gst);
                updateRow(row);
                updateTotalFinalAmount();
            }
        });

        // --- NEW: When GST number changes, update all rows ---
        document.getElementById('bill_to_gst_number').addEventListener('change', function () {
            document.querySelectorAll("#item-table tr").forEach(row => {
                let productSelect = row.querySelector('.product-select');
                if (productSelect) {
                    let gst = parseFloat(productSelect.options[productSelect.selectedIndex]?.getAttribute('data-gst')) || 0;
                    distributeGST(row, gst);
                    updateRow(row);
                }
            });
            updateTotalFinalAmount();
        });

        // --- Also trigger on page load (optional) ---
        updateTotalFinalAmount();

    });
    table.addEventListener("input", function (e) {
        if (
            e.target.name === "margin[]" ||
            e.target.name === "quantity[]" ||
            e.target.name === "cgst[]" ||
            e.target.name === "sgst[]" ||
            e.target.name === "igst[]"
        ) {
            let row = e.target.closest('tr');
            updateRow(row);
            updateTotalFinalAmount();
        }
    });
    

    /* --- END OF SCRIPT --- */
</script>

<style>
    .custcss {
        border: none;
        background-color: transparent;
        text-align: left;
        width: 200px;
        padding: 1px;
        font-size: 14px;
        color: #000;
    }
</style>

{% endblock %}