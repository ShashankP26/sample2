{% load humanize %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=800"/>
  <title>Quotation Preview</title>
  <link href="https://unpkg.com/@tabler/core@latest/dist/css/tabler.min.css" rel="stylesheet"/>
  <style>
    @page { size: A4; margin: 18mm 0; }
    html, body {
      background: #f6f8fb; box-sizing: border-box; margin: 0; padding: 0;
    }
    .quote-box {
      width: 185mm;
      min-height: 251mm;
      margin: 32px auto;
      background: #fff;
      border-radius: 0.45rem;
      box-shadow: 0 0 10px rgba(0,0,0,0.07);
      padding: 28px;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
    }
    .quote-header {
      display: flex; justify-content: space-between; align-items: flex-start; gap: 20px;
      margin-bottom: 15px; border-bottom: 1px solid #e0e6ed; padding-bottom: 9px;
    }
    .quote-section h3 { font-weight: 600; font-size: 15px; margin-bottom: 6px;}
    .address-row { margin-bottom: 10px; }
    .address-p { margin-bottom: 0; line-height: 1.6; }

    .quote-table {
      table-layout: fixed;
      width: 100%;
      font-size: 12.5px;
      border-collapse: collapse;
      margin-top: 25px;
      margin-bottom: 10px;
    }
    .quote-table thead th { background: #eff3fb; font-weight: 700; color: #222; }
    .quote-table th, .quote-table td {
      border: 1px solid #b6bcc6; text-align: center; vertical-align: middle;
      padding: 7px 4px; word-break: break-word;
    }
    .quote-table td.product { text-align: left; }

    .totals-block { display: flex; justify-content: flex-end; gap: 20px; margin-top: 20px; flex-wrap: wrap;}
    .totals table { width: 100%; }
    .totals td { padding: 2px 0; font-size: 14px; }
    .totals td:first-child { text-align: left; }
    .totals td:last-child { text-align: right; }
    
    .styled-box { 
      margin-top: 30px; 
      font-size: 13px;
    }
    .styled-box h3 {
      background-color: #eff3fb;
      padding: 10px 15px;
      margin-bottom: 0;
      border: 1px solid #e0e6ed;
      border-bottom: none;
      border-radius: 4px 4px 0 0;
      font-size: 15px;
      font-weight: 600;
    }
    .styled-box ul {
      margin: 0;
      padding: 15px 15px 15px 40px;
      border: 1px solid #e0e6ed;
      border-radius: 0 0 4px 4px;
      background-color: #f6f8fb;
      list-style-position: outside;
    }
    .styled-box li {
      padding-bottom: 5px;
    }
    .styled-box li:last-child {
      padding-bottom: 0;
    }

    /* NEW: Style for the plain bank details section */
    .bank-details {
      margin-top: 30px;
    }
    
    /* MODIFIED: Increased margin-top to move signature down */
    .signature { 
      text-align: right; 
      margin-top: 80px; 
      font-size: 15px; 
      min-height: 45px; 
      border: none; 
    }
    
    footer { text-align: center; font-size: 12px; margin-top: 32px; }

    @media print {
      html, body { background: none !important; min-height: 0; height: auto; margin: 0 !important; padding: 0 !important; }
      body, .quote-box { box-shadow: none !important; }
      .quote-box {
        width: 185mm !important; min-height: 251mm !important;
        margin: 0 auto !important; border-radius: 0; padding: 0 !important;
      }
      .print-button { display: none !important; }
      .totals-block, .styled-box, .bank-details, .signature, footer { page-break-inside: avoid; }
      .quote-table { page-break-inside: auto; }
      .quote-table thead { display: table-header-group; }
    }
</style>
</head>
<body>
<div class="quote-box">

  <!-- Header -->
  <div class="quote-header">
    <img src="{% static 'xlogo.png' %}" width="120" alt="Xpredict Logo" />
    <div style="text-align:right; font-size:16px;">
      <strong>Date:</strong> {{ current_date }}<br>
      <strong>Quotation No:</strong> {{ quotation.quotation_no }}
    </div>
  </div>

  <!-- From Block -->
  <div class="quote-section address-row">
    <h3>From:</h3>
    <p class="address-p">
      {{ quotation.from_company_name }}<br>
      {{ quotation.from_address }}<br>
      Phone: {{ quotation.from_phone }}<br>
      Email: {{ quotation.from_email }}<br>
      GST: {{ quotation.from_gst }}<br>
      PAN: {{ quotation.from_pan }}
    </p>
  </div>

  <!-- Bill To / Ship To Row (side by side) - FIXED -->
  <table style="width: 100%; border-collapse: collapse; margin-bottom: 12px;">
      <tr>
          <td style="width: 50%; vertical-align: top; padding-right: 16px;">
              <div class="quote-section">
                <h3>Bill To:</h3>
                <p class="address-p">
                  {{ quotation.bill_to_company_name }}<br>
                  Customer Name: {{ quotation.bill_to_customer_name }}<br>
                  GST: {{ quotation.bill_to_gst_number }}<br>
                  Address: {{ quotation.bill_to_address }}
                </p>
              </div>
          </td>
          <td style="width: 50%; vertical-align: top; padding-left: 16px;">
              <div class="quote-section">
                <h3>Ship To:</h3>
                <p class="address-p">
                  {{ quotation.ship_to_company_name }}<br>
                  Customer Name: {{ quotation.ship_to_customer_name }}<br>
                  GST: {{ quotation.ship_to_gst_number }}<br>
                  Address: {{ quotation.ship_to_address }}
                </p>
              </div>
          </td>
      </tr>
  </table>

  <!-- Items Table with commented columns and adjusted widths -->
  <table class="quote-table">
    <colgroup>
      <col style="width: 5%;">   <!-- SL -->
      <col style="width: 50%;">  <!-- Product -->
      <col style="width: 10%;">  <!-- HSN -->
      <col style="width: 12%;">  <!-- Unit Price -->
      <col style="width: 8%;">   <!-- Qty -->
      <col style="width: 15%;">  <!-- Taxable Amt -->
      <!--
      <col style="width: 6%;">
      <col style="width: 6%;">
      <col style="width: 6%;">
      <col style="width: 12%;">
      -->
    </colgroup>
    <thead>
      <tr>
        <th>SL</th>
        <th class="product">Product</th>
        <th>HSN</th>
        <th>Unit Price</th>
        <th>Qty</th>
        <th>Taxable Amt</th>
        <!--
        <th>CGST</th>
        <th>SGST</th>
        <th>IGST</th>
        <th>Total</th>
        -->
      </tr>
    </thead>
    <tbody>
      {% for item in quotation_items %}
      <tr>
        <td>{{ forloop.counter }}</td>
        <td class="product">{{ item.product.name }}</td>
        <td>{{ item.hsncode }}</td>
        <td>{{ item.unit_price|floatformat:2 }}</td>
        <td>{{ item.quantity }}</td>
        <td>{{ item.rate|intcomma }}</td>
        <!--
        <td>{{ item.cgst }}%</td>
        <td>{{ item.sgst }}%</td>
        <td>{{ item.igst }}%</td>
        <td>{{ item.final_amount|intcomma }}</td>
        -->
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- Totals Block -->
  <div class="totals-block">
    <div class="totals" style="width: 40%;">
      <table>
          <tr>
              <td><strong>Subtotal:</strong></td>
              <td>₹{{ quotation.subtotal|intcomma }}</td>
          </tr>

          <tr>
              <td><strong>CGST Total:</strong></td>
              <td>₹{{ quotation.cgst_total|intcomma }}</td>
          </tr>
          <tr>
              <td><strong>SGST Total:</strong></td>
              <td>₹{{ quotation.sgst_total|intcomma }}</td>
          </tr>
          <tr>
              <td><strong>IGST Total:</strong></td>
              <td>₹{{ quotation.igst_total|intcomma }}</td>
          </tr>

          <tr>
              <td><strong>Grand Total:</strong></td>
              <td>₹{{ quotation.grand_total|intcomma }}</td>
          </tr>
      </table>
    </div>
  </div>

  <div style="margin-top: 14px; font-size:14px;">
    <strong>Total in Words:</strong> {{ grand_total_in_words }}
  </div>

  <!-- Terms & Conditions Section -->
  <div class="styled-box">
    <h3>Terms & Conditions</h3>
    <ul>
      {% for term in quotation.terms_and_conditions.splitlines %}
      <li>{{ term }}</li>
      {% endfor %}
    </ul>
  </div>

  <!-- MODIFIED: Bank Details now have a plain style -->
  <div class="quote-section bank-details">
    <h3>Bank Details</h3>
    <p class="address-p">
      Bank Name: {{ quotation.bank.bank_name }}<br>
      A/C Holder: {{ quotation.bank.account_holder_name }}<br>
      A/C Number: {{ quotation.bank.account_number }}<br>
      IFSC: {{ quotation.bank.ifsc_code }}<br>
      Branch: {{ quotation.bank.branch_name }}
    </p>
  </div>

  <!-- MODIFIED: Signature block pushed down -->
  <div class="signature">
    <strong>Authorized Signature</strong>
  </div>

  <footer>
    © Xpredict Labs. All rights reserved.
  </footer>
</div>

<!-- Print Button -->
<div class="text-center mt-4 print-button">
  <button class="btn btn-primary" onclick="window.print()">
    <i class="ti ti-printer"></i> Print Quotation
  </button>
</div>
<script src="https://unpkg.com/@tabler/core@latest/dist/js/tabler.min.js"></script>
</body>
</html>
